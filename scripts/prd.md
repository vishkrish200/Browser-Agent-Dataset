# PRD — Browser-Agent Dataset MVP  
**Last updated:** 2025-05-09  
**Author / DRI:** _your-name_  
**Stakeholders:** Engineering, Data Science, Biz Dev (licensing), Early Design Partners (General Agents)  
**Status:** Draft

---

## 1. Overview  
We are building an **open, production-ready orchestration layer that leverages best-in-class browser automation services (Browserbase and Stagehand) to record real browser interactions and package them as a clean, portable dataset** for fine-tuning large language models (LLMs) into web-capable agents.

* **Problem** LLMs lack structured, step-by-step web-interaction supervision; they struggle with tasks that require clicking, typing, scrolling, and navigating.  
* **Audience** AI research labs, open-source model builders, agent-platform startups.  
* **Value** A flexible orchestration platform that utilizes **Browserbase for scalable cloud browser infrastructure and Stagehand for robust interaction definition and execution**, enabling rapid generation of high-quality web interaction datasets. Includes a reference LoRA recipe that boosts a 7 B model's Mind2Web/WebArena score in days—demonstrating the value of the dataset collected via this new, efficient pipeline.

---

## 2. Core Features  

| Feature | What it does | Why it matters | How it works (high level) |
|---------|--------------|----------------|---------------------------|
| **Browserbase Orchestrator** | Manages scalable cloud browser sessions via Browserbase. | Provides robust, stealthy, and easily configurable browser environments without manual infrastructure setup. | Interfaces with Browserbase API to launch, configure (proxies, stealth, user agents), and manage browser instances for data collection. |
| **Stagehand Interaction Engine** | Defines and executes scripted **Workflows** and exploratory interactions using Stagehand. | Leverages Stagehand's capabilities for precise and reliable web interaction, generating structured action traces. | Defines interaction tasks/scripts compatible with Stagehand; triggers Stagehand execution within Browserbase-managed sessions; retrieves structured action data. |
| **Unified Data Collector** | Gathers rendered HTML, WebP screenshots, and action JSON from Browserbase and Stagehand for each step. | Supplies both textual DOM and visual context from managed services; supports text-only or VLM fine-tunes. | Configures Browserbase for session recording (HTML, screenshots); retrieves action metadata from Stagehand; stores data (e.g., in S3). |
| **Pre-processor** | Strips PII, gzips HTML, dedups no-ops, caps token length. | Keeps dataset legal, compact, trainer-friendly. | Spark/Ray job (or custom Python scripts) operating on data retrieved from Browserbase/Stagehand; DOM diff filter; HTML minifier. |
| **Dataset Builder (JSONL)** | Emits lines `<DOM>…<ACTION> click …` (+ optional `<IMAGE>` link). | Universal format; plug-and-play with any HF/PEFT stack. | Python script bundles HTML (or screenshot path) and Stagehand action data into JSONL. |
| **PEFT Fine-tune Recipe** | Reference LoRA & Q-LoRA config for Qwen-2 / Mistral. | Shows users exactly how to use the dataset; validates quality. | Hugging Face PEFT; Flash-Attention-2; fits on a 24 GB GPU. |
| **Eval Harness** | Runs WebArena & Mind2Web dev subset out-of-the-box. | Provides instant, objective uplift metric. | Docker Compose spins vLLM server + benchmark runner. |

---

## 3. User Experience  

### Personas  
* **Lab Researcher "Alex"** — prototypes internal browser agents using datasets generated by the orchestrator.  
* **Open-Source Maintainer "Billie"** — replicates benchmarks publicly with datasets from the orchestrator.  
* **Biz-Dev "Cass"** — evaluates datasets for licensing value.

### Key Flows  
1. `collector run --site youtube --workflow video_discovery_v1` → raw interaction data (HTML, screenshots, Stagehand action logs) from Browserbase/Stagehand appears.  
2. `python build_jsonl.py` → `train.jsonl` ready.  
3. `python run_lora.py` → LoRA adapter saved.  
4. `python eval/mind2web_eval.py` → success % printed.

### UI / UX Considerations  
* CLI-first; single `.env` for Browserbase and Stagehand API keys, and any proxy keys if managed outside Browserbase.  
* README with one-liner commands for core orchestration tasks.  
* Docs include schema diagram for data sourced from Browserbase/Stagehand + sample JSONL lines.

---

## 4. Technical Architecture  

| Layer | Components |
|-------|------------|
| **Orchestration & Collection** | Python-based orchestration service; **Browserbase API Client** for managing cloud browser sessions; **Stagehand API Client** for defining and executing interaction tasks. Redis queue for task management (optional). |
| **Storage** | S3 bucket (`s3://checkpoints/{session_id}/{step_id}.{html,webp,action.json}`); lifecycle policy archives screenshots post-build. Data sourced from Browserbase session recordings and Stagehand action logs. |
| **Processing** | Spark/Ray on spot instances (or Python scripts); jobs: `pii_scrub`, `dom_diff`, `html_minify`, `gzip` operating on collected data. |
| **Dataset Service** | Python builders output `train.jsonl`, `val.jsonl`, and optional `train_mm.jsonl` (with screenshot links), consuming data from the Storage layer. |
| **Training** | Single-GPU PEFT pipeline (LoRA rank 16) for Qwen-2-7B, Mistral-7B, etc. |
| **Evaluation** | Docker Compose: vLLM server + WebArena/Mind2Web runner. |
| **CI/CD** | GitHub Actions: lint, unit tests, nightly smoke-crawl, mini LoRA sanity-train. |
| **Infra** | AWS EC2 collectors; optional EKS; CloudWatch error alerts.

**Data Model (per step)**  
```jsonc
{
  "step_id": "sha256:…", // Or a new ID scheme based on Browserbase/Stagehand outputs
  "session_id": "browserbase_session_xyz", // Example
  "stagehand_task_id": "stagehand_task_abc", // Example
  "url": "https://www.youtube.com/",
  "ts": 1715259655,
  "action": { 
    // This structure will largely be defined by Stagehand's output
    "type": "click", 
    "selector": "#video-title", 
    "text": "LoFi Mix",
    "stagehand_metadata": { ... } // Any specific metadata from Stagehand
  },
  "obs_html_gzip": "s3://chk/xyz/abc/step.htm.gz", // Path to HTML from Browserbase
  "screenshot_webp": "s3://chk/xyz/abc/step.webp" // Path to screenshot from Browserbase
}